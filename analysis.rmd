---
title: "Does COVID affect voter preferences?"
author: "David Azizi & Judah Newman"
date: "10/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(huxtable)
```

We are using Change Research's set of survey respondents to explore whether COVID has changed their political alignment or opinions of political figures. 

Our two sources of data:
- Change Research respondents since the third week of 2020 up to last week.
- JHU CSSE's timeseries of COVID-19 cases by county for the same time period.

Our potential dependent variables will be explored in more detail later on.

## Import Survey Data

We must first extract the survey respondent data. We select some political preferences and demographics per respondent, as well as the population and vote history of the respondent's county.

*This query is not run when the document is rendered because I didn't want to muck around with ODBC in RStudio.*
```{}
select
    pd.week,
    pd.state_abbrev,
    pd.county_descr,
    pd.fips_code,
    pd.biden,
    pd.trump,
    pd.clinton_biden,
    pd.trump_trump,
    pd.clinton_trump,
    pd.trump_biden,
    ftb.biden_ft,
    ftt.trump_ft,
    pd.ethnicity,
    pd.age,
    pd.male,
    pd.county_clinton,
    pd.county_trump,
    pd.county_trump_margin,
    pd.county_pop
from
(select
    sr.id,
    FROM_UNIXTIME(sr.date_created,'%Y-%U') as week,
    z.state_abbrev,
    cn.county_descr,
    cn.fips_code,
    if(c.text like '%Biden%', 1, 0) as biden,
    if(c.text like '%Trump%', 1, 0) as trump,
    if(sr.president_vote_2016 like '%Clinton%' and c.text like '%Biden%', 1, 0) as clinton_biden,
    if(sr.president_vote_2016 like '%Trump%' and c.text like '%Trump%', 1, 0) as trump_trump,
    if(sr.president_vote_2016 like '%Clinton%' and c.text like '%Trump%', 1, 0) as clinton_trump,
    if(sr.president_vote_2016 like '%Trump%' and c.text like '%Biden%', 1, 0) as trump_biden,
    sr.ethnicity,
    2020 - sr.year_born as age,
    if(sr.gender like 'Male', 1, 0) as male,
    cn.votes_2016_clinton / cn.votes_2016_all as county_clinton,
    cn.votes_2016_trump / cn.votes_2016_all as county_trump,
    (cn.votes_2016_trump - cn.votes_2016_clinton) / cn.votes_2016_all as county_trump_margin,
    pop_2017_18plus as county_pop
from survey_data.survey_responders sr
    join survey_data.surveys s
        on sr.survey_id = s.id
    join survey_data.survey_responses r
        on sr.id = r.survey_responder_id
    join survey_data.survey_questions q
        on q.id = r.survey_question_id
        and q.heading in (
        'If the election for President were held today, who would you vote for?',
        'If the 2020 general election for President were held today and the candidates were the following, who would you vote for?',
        'If the election for President were held today and the candidates were the following, who would you vote for?',
        'If the November election for President were held today, who would you vote for?'
        )
    join survey_data.survey_choices c
        on c.id = r.survey_choice_id
        and c.survey_question_id = q.id
    join (select ZCTA, state_abbrev, association_id from zip_map where association_type = 'county' group by ZCTA) z
        on z.ZCTA = sr.zip_code
    join counties cn
        on z.state_abbrev = cn.state_abbrev
        and z.association_id = cn.county_code
where sr.date_created > UNIX_TIMESTAMP(20191231)) as pd
join (select
                  sr.id,
                  c.text as biden_ft
from survey_data.survey_responders sr
    join survey_data.surveys s
        on sr.survey_id = s.id
    join survey_data.survey_responses r
        on sr.id = r.survey_responder_id
    join survey_data.survey_questions q
        on q.id = r.survey_question_id
        and q.heading in (
        'On a scale of 1-10, how do you feel about Joe Biden? 1 means you strongly oppose him and 10 means you strongly support him.'
        )
    join survey_data.survey_choices c
        on c.id = r.survey_choice_id
        and c.survey_question_id = q.id
where sr.date_created > UNIX_TIMESTAMP(20191231)
) ftb on pd.id = ftb.id
join (select
             sr.id,
             c.text as trump_ft
from survey_data.survey_responders sr
    join survey_data.surveys s
        on sr.survey_id = s.id
    join survey_data.survey_responses r
        on sr.id = r.survey_responder_id
    join survey_data.survey_questions q
        on q.id = r.survey_question_id
        and q.heading in (
        'On a scale of 1-10, how do you feel about President Donald Trump? 1 means you strongly oppose him and 10 means you strongly support him.'
        )
    join survey_data.survey_choices c
        on c.id = r.survey_choice_id
        and c.survey_question_id = q.id
where sr.date_created > UNIX_TIMESTAMP(20191231)
) ftt on pd.id = ftt.id
```
A CSV is saved from DataGrip; we import it here.

```{r survey_data}
survey <- read.csv("respondents.csv")
```

## Importing and Manipulating COVID Data

We download the latest data from the JHU CSSE's GitHub. We make a long table, calculate the delta in cases, and summarize by county and week.

```{r covid_data}
covid_wide <-
  read.csv(
    "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")
covid_long <- pivot_longer(covid_wide, starts_with("X"), names_to = "date")
covid_long$date <- as.Date(covid_long$date, format = "X%m.%d.%y")
covid_long <- covid_long[!is.na(covid_long$FIPS),]
covid_long <- covid_long[order(covid_long$FIPS, covid_long$date),]
covid_long[["new_cases"]] <-
  c(0, covid_long$value[-1] - covid_long$value[1:length(covid_long$value) - 1])
covid_long[covid_long$date == "2020-01-22", "new_cases"] <- 0
covid_long[["week"]] <- format(covid_long$date, "%Y-%U")
covid <-
  covid_long %>% 
  group_by(FIPS, week) %>% 
  summarize(cases = sum(new_cases), .groups = "keep")
```

## Join Survey and COVID Data

We merge (by default, a left join) on FIPS code as an integer and week, giving us one row per respondent with weekly COVID-19 case counts for each respondent's county.
```{r join}
dta <-
  merge(survey,
        covid,
        by.x = c("fips_code", "week"),
        by.y = c("FIPS", "week"))

dta <- dta[!dta$week %in% c("2020-02", strftime(Sys.Date(), format = "%Y-%U")),]
dta[["weekn"]] <- as.numeric(substr(dta$week, 6, 7))

write.csv(dta, file = "respondents_covid.csv")
```

## Probability of Voting for Each Candidate
We have a set of binary variables to consider as dependent here:
- Biden 2020 intended vote
- Trump 2020 intended vote
- Clinton to Trump switcher
- Biden to Trump switcher

Since they are binary values between 0 and 1, a logistic regression will yield more helpful coefficients. In a logit model, the predicted y is interpreted as the log-odds of the dependent variable taking on a value of 1 (true), i.e. as a probability.

The second two options for dependent variable more clearly get at our original question of "does COVID affect voter preferences?" but unfortunately suffer from case bias. The overwhelming number of our respondents are NOT switchers. Sampling in equal proportion to achieve balance is a future goal of this project. For now, we proceed to analyze the probability of voting for each candidate as a result of COVID case counts in the respondent's county.

### Trump
```{r trump_prob}
t.m1 <- glm(
  trump ~ cases,
  data = dta,
  family = binomial(link = "logit")
)
t.m2 <- glm(
  trump ~ cases + weekn,
  data = dta,
  family = binomial(link = "logit")
)
t.m3 <- glm(
  trump ~ cases + weekn + male + age + ethnicity,
  data = dta,
  family = binomial(link = "logit")
)
t.m4 <- glm(
  trump ~ cases + weekn + male + age + ethnicity + county_trump_margin,
  data = dta,
  family = binomial(link = "logit")
)

huxreg(t.m1, t.m2, t.m3, t.m4)
```

### Biden

The balance is a little off for Biden support, as there is a conservative bias in our subject recruitment. It's still much closer than the switchers.

```{r biden_prob}
b.m1 <- glm(
  biden ~ cases,
  data = dta,
  family = binomial(link = "logit")
)
b.m2 <- glm(
  biden ~ cases + weekn,
  data = dta,
  family = binomial(link = "logit")
)
b.m3 <- glm(
  biden ~ cases + weekn + male + age + ethnicity,
  data = dta,
  family = binomial(link = "logit")
)
b.m4 <- glm(
  biden ~ cases + weekn + male + age + ethnicity + county_trump_margin,
  data = dta,
  family = binomial(link = "logit")
)

huxreg(b.m1, b.m2, b.m3, b.m4)
```

### Interpretation

It's unclear if there's any affect here. The simpler models would suggest a preference for Biden in countues with higher cases, but controlling for the intrinsic political disposition of the county reverses that effect. (Notice how the sign of the coefficient on `cases` flips once we incorporate the county's margin for Trump.)

The effect size is also extremely small to begin with. A false sense of confidence emerges from the sample size, since we have a row per respondent but we only have unique COVID information per county.

## Trump Feeling Thermometer (1-10)

A logistic regression will not work for values between 1 and 10. We will proceed with an OLS model. 

*suspending work here to share results with team*

